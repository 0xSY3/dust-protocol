// Stealth address types (ERC-5564/6538)

export interface StealthKeyPair {
  spendingPrivateKey: string;
  spendingPublicKey: string;
  viewingPrivateKey: string;
  viewingPublicKey: string;
}

export interface StealthMetaAddress {
  prefix: string;
  spendingPublicKey: string;
  viewingPublicKey: string;
  raw: string;
}

export interface GeneratedStealthAddress {
  stealthAddress: string;         // CREATE2 wallet address (payment destination)
  stealthEOAAddress: string;      // EOA address (the "owner", for signing)
  ephemeralPublicKey: string;
  viewTag: string;
  stealthPublicKey: string;
}

export interface StealthAnnouncement {
  schemeId: number;
  stealthAddress: string;
  ephemeralPublicKey: string;
  viewTag: string;
  metadata: string;
  linkSlug?: string;
  caller: string;
  blockNumber: number;
  txHash: string;
}

export interface ScanResult {
  announcement: StealthAnnouncement;
  stealthPrivateKey: string;
  isMatch: boolean;
  privateKeyVerified?: boolean;
  derivedAddress?: string;
  walletType?: 'eoa' | 'create2' | 'account';
}

export const SCHEME_ID = { SECP256K1: 1 } as const;

export interface StealthContractAddresses {
  announcer: string;
  registry: string;
}

function getEnv(key: string): string | undefined {
  if (typeof window !== 'undefined') {
    return (window as unknown as { __ENV?: Record<string, string> }).__ENV?.[key]
      || process.env[key];
  }
  return process.env[key];
}

function getContractAddresses(): StealthContractAddresses {
  const announcer = getEnv('NEXT_PUBLIC_STEALTH_ANNOUNCER_ADDRESS');
  const registry = getEnv('NEXT_PUBLIC_STEALTH_REGISTRY_ADDRESS');

  if (announcer && registry) return { announcer, registry };

  // Thanos Sepolia defaults (redeployed 2026-02-07)
  return {
    announcer: '0x2C2a59E9e71F2D1A8A2D447E73813B9F89CBb125',
    registry: '0x9C527Cc8CB3F7C73346EFd48179e564358847296',
  };
}

export const CANONICAL_ADDRESSES = getContractAddresses();

// Block number when contracts were deployed â€” scanner should never start after this
export const DEPLOYMENT_BLOCK = 6272527;

// CREATE2 Stealth Wallet Factory (Thanos Sepolia)
export const STEALTH_WALLET_FACTORY = '0x85e7Fe33F594AC819213e63EEEc928Cb53A166Cd';
export const STEALTH_WALLET_CREATION_CODE = '0x60a060405234801561000f575f80fd5b506040516107e03803806107e083398101604081905261002e9161003f565b6001600160a01b031660805261006c565b5f6020828403121561004f575f80fd5b81516001600160a01b0381168114610065575f80fd5b9392505050565b60805161074f6100915f395f8181607e015281816101a90152610365015261074f5ff3fe608060405260043610610041575f3560e01c80635cd5972c1461004c5780638da5cb5b1461006d578063affed0e0146100bd578063da0980c7146100df575f80fd5b3661004857005b5f80fd5b348015610057575f80fd5b5061006b610066366004610599565b6100fe565b005b348015610078575f80fd5b506100a07f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b0390911681526020015b60405180910390f35b3480156100c8575f80fd5b506100d15f5481565b6040519081526020016100b4565b3480156100ea575f80fd5b5061006b6100f93660046105e8565b61028f565b5f80546040516bffffffffffffffffffffffff1930606090811b8216602084015287901b16603482015260488101919091524660688201526088016040516020818303038152906040528051906020012090505f8160405160200161018f91907f19457468657265756d205369676e6564204d6573736167653a0a3332000000008152601c810191909152603c0190565b6040516020818303038152906040528051906020012090507f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03166101dc828686610459565b6001600160a01b031614610202576040516282b42960e81b815260040160405180910390fd5b5f8054908061021083610680565b909155505060405147905f906001600160a01b0388169083908381818185875af1925050503d805f811461025f576040519150601f19603f3d011682016040523d82523d5f602084013e610264565b606091505b5050905080610286576040516312171d8360e31b815260040160405180910390fd5b50505050505050565b5f30878787876040516102a3929190610698565b6040519081900381205f546bffffffffffffffffffffffff19606096871b811660208501529490951b90931660348201526048810191909152606881019190915260888101919091524660a882015260c8016040516020818303038152906040528051906020012090505f8160405160200161034b91907f19457468657265756d205369676e6564204d6573736167653a0a3332000000008152601c810191909152603c0190565b6040516020818303038152906040528051906020012090507f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316610398828686610459565b6001600160a01b0316146103be576040516282b42960e81b815260040160405180910390fd5b5f805490806103cc83610680565b91905055505f886001600160a01b03168888886040516103ed929190610698565b5f6040518083038185875af1925050503d805f8114610427576040519150601f19603f3d011682016040523d82523d5f602084013e61042c565b606091505b505090508061044e576040516312171d8360e31b815260040160405180910390fd5b505050505050505050565b5f6041821461046957505f610532565b5f61047760208285876106a7565b610480916106ce565b90505f6104916040602086886106a7565b61049a916106ce565b90505f858560408181106104b0576104b06106ec565b919091013560f81c915050601b8110156104d2576104cf601b82610700565b90505b604080515f81526020810180835289905260ff831691810191909152606081018490526080810183905260019060a0016020604051602081039080840390855afa158015610522573d5f803e3d5ffd5b5050506020604051035193505050505b9392505050565b80356001600160a01b038116811461054f575f80fd5b919050565b5f8083601f840112610564575f80fd5b50813567ffffffffffffffff81111561057b575f80fd5b602083019150836020828501011115610592575f80fd5b9250929050565b5f805f604084860312156105ab575f80fd5b6105b484610539565b9250602084013567ffffffffffffffff8111156105cf575f80fd5b6105db86828701610554565b9497909650939450505050565b5f805f805f80608087890312156105fd575f80fd5b61060687610539565b955060208701359450604087013567ffffffffffffffff80821115610629575f80fd5b6106358a838b01610554565b9096509450606089013591508082111561064d575f80fd5b5061065a89828a01610554565b979a9699509497509295939492505050565b634e487b7160e01b5f52601160045260245ffd5b5f600182016106915761069161066c565b5060010190565b818382375f9101908152919050565b5f80858511156106b5575f80fd5b838611156106c1575f80fd5b5050820193919092039150565b803560208310156106e6575f19602084900360031b1b165b92915050565b634e487b7160e01b5f52603260045260245ffd5b60ff81811683821601908111156106e6576106e661066c56fea2646970667358221220befef0ffbba9994d696b7cbf8606cc6dda0e5a488ebe379619b08c1a4531e38b64736f6c63430008140033';

export const STEALTH_WALLET_FACTORY_ABI = [
  'function computeAddress(address _owner) view returns (address)',
  'function deploy(address _owner) returns (address wallet)',
  'function deployAndDrain(address _owner, address _to, bytes _sig)',
];

// ERC-4337 Stealth Account (Thanos Sepolia)
export const ENTRY_POINT_ADDRESS = '0x5c058Eb93CDee95d72398E5441d989ef6453D038';
export const STEALTH_ACCOUNT_FACTORY = '0x0D93df03e6CF09745A24Ee78A4Cab032781E7aa6';
export const DUST_PAYMASTER_ADDRESS = '0x9e2eb36F7161C066351DC9E418E7a0620EE5d095';
export const STEALTH_ACCOUNT_CREATION_CODE = '0x60c060405234801561000f575f80fd5b506040516107c23803806107c283398101604081905261002e9161005c565b6001600160a01b039182166080521660a052610094565b6001600160a01b0381168114610059575f80fd5b50565b5f806040838503121561006d575f80fd5b825161007881610045565b602084015190925061008981610045565b809150509250929050565b60805160a0516106f36100cf5f395f8181609a01526101ea01525f818160e5015281816101530152818161029f015261035e01526106f35ff3fe60806040526004361061004c575f3560e01c80633a871cdd146100575780638da5cb5b14610089578063b0d691fe146100d4578063b61d27f614610107578063ece5313214610128575f80fd5b3661005357005b5f80fd5b348015610062575f80fd5b506100766100713660046104e3565b610147565b6040519081526020015b60405180910390f35b348015610094575f80fd5b506100bc7f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b039091168152602001610080565b3480156100df575f80fd5b506100bc7f000000000000000000000000000000000000000000000000000000000000000081565b348015610112575f80fd5b5061012661012136600461054d565b610294565b005b348015610133575f80fd5b506101266101423660046105cd565b610353565b5f336001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016146101915760405163bd07c55160e01b815260040160405180910390fd5b6040517f19457468657265756d205369676e6564204d6573736167653a0a3332000000006020820152603c81018490525f90605c0160408051601f19818403018152919052805160209091012090506001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000166102218261021c6101408901896105e6565b610404565b6001600160a01b03161461023957600191505061028d565b8215610288576040515f90339085908381818185875af1925050503d805f811461027e576040519150601f19603f3d011682016040523d82523d5f602084013e610283565b606091505b505050505b5f9150505b9392505050565b336001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016146102dd5760405163bd07c55160e01b815260040160405180910390fd5b5f80856001600160a01b03168585856040516102fa929190610630565b5f6040518083038185875af1925050503d805f8114610334576040519150601f19603f3d011682016040523d82523d5f602084013e610339565b606091505b50915091508161034b57805160208201fd5b505050505050565b336001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000161461039c5760405163bd07c55160e01b815260040160405180910390fd5b478015610400575f826001600160a01b0316826040515f6040518083038185875af1925050503d805f81146103ec576040519150601f19603f3d011682016040523d82523d5f602084013e6103f1565b606091505b50509050806103fe575f80fd5b505b5050565b5f6041821461041457505f61028d565b5f610422602082858761063f565b61042b91610666565b90505f61043c60406020868861063f565b61044591610666565b90505f8585604081811061045b5761045b610684565b919091013560f81c915050601b81101561047d5761047a601b82610698565b90505b604080515f81526020810180835289905260ff831691810191909152606081018490526080810183905260019060a0016020604051602081039080840390855afa1580156104cd573d5f803e3d5ffd5b5050604051601f19015198975050505050505050565b5f805f606084860312156104f5575f80fd5b833567ffffffffffffffff81111561050b575f80fd5b8401610160818703121561051d575f80fd5b95602085013595506040909401359392505050565b80356001600160a01b0381168114610548575f80fd5b919050565b5f805f8060608587031215610560575f80fd5b61056985610532565b935060208501359250604085013567ffffffffffffffff8082111561058c575f80fd5b818701915087601f83011261059f575f80fd5b8135818111156105ad575f80fd5b8860208285010111156105be575f80fd5b95989497505060200194505050565b5f602082840312156105dd575f80fd5b61028d82610532565b5f808335601e198436030181126105fb575f80fd5b83018035915067ffffffffffffffff821115610615575f80fd5b602001915036819003821315610629575f80fd5b9250929050565b818382375f9101908152919050565b5f808585111561064d575f80fd5b83861115610659575f80fd5b5050820193919092039150565b8035602083101561067e575f19602084900360031b1b165b92915050565b634e487b7160e01b5f52603260045260245ffd5b60ff818116838216019081111061067e57634e487b7160e01b5f52601160045260245ffdfea2646970667358221220601ea57e2ed5cdf5f17b7c85f83eb0ab766851da51f6e42ccb933373281567c464736f6c63430008140033';

export const STEALTH_ACCOUNT_FACTORY_ABI = [
  'function createAccount(address _owner, uint256 _salt) returns (address account)',
  'function getAddress(address _owner, uint256 _salt) view returns (address)',
];

export const ENTRY_POINT_ABI = [
  'function handleOps(tuple(address sender, uint256 nonce, bytes initCode, bytes callData, uint256 callGasLimit, uint256 verificationGasLimit, uint256 preVerificationGas, uint256 maxFeePerGas, uint256 maxPriorityFeePerGas, bytes paymasterAndData, bytes signature)[] ops, address beneficiary)',
  'function getUserOpHash(tuple(address sender, uint256 nonce, bytes initCode, bytes callData, uint256 callGasLimit, uint256 verificationGasLimit, uint256 preVerificationGas, uint256 maxFeePerGas, uint256 maxPriorityFeePerGas, bytes paymasterAndData, bytes signature) userOp) view returns (bytes32)',
  'function getNonce(address sender, uint192 key) view returns (uint256)',
  'function balanceOf(address account) view returns (uint256)',
  'function depositTo(address account) payable',
];

export const DUST_PAYMASTER_ABI = [
  'function getHash(tuple(address sender, uint256 nonce, bytes initCode, bytes callData, uint256 callGasLimit, uint256 verificationGasLimit, uint256 preVerificationGas, uint256 maxFeePerGas, uint256 maxPriorityFeePerGas, bytes paymasterAndData, bytes signature) userOp, uint48 validUntil, uint48 validAfter) view returns (bytes32)',
  'function verifyingSigner() view returns (address)',
];
